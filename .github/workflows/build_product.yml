name: Release Build product

on:
  workflow_dispatch:
    inputs:
      TOOLCHAINS:
        type: choice
        description: "ä½¿ç”¨çš„å·¥å…·é“¾"
        required: true
        default: "nightly"
        options:
          - "nightly"
          - "stable"
      TARGET:
        type: choice
        description: "ç¼–è¯‘çš„ç›®æ ‡ä¸‰å…ƒç»„"
        required: true
        default: "x86_64-unknown-linux-gnu"
        options:
          - "x86_64-unknown-linux-gnu"
          - "aarch64-unknown-linux-gnu"
          - "x86_64-unknown-linux-musl"
          - "aarch64-unknown-linux-musl"
          - "x86_64-pc-windows-msvc"
          - "aarch64-pc-windows-msvc"
          - "aarch64-apple-darwin"
          - "x86_64-apple-darwin"

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Optimize build performance
  CARGO_INCREMENTAL: 0
  TZ: Asia/Shanghai

jobs:
  # Build strategy check - determine build type based on trigger
  build-check:
    name: Build Strategy Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Debug Show Selected Inputs
        run: |
          echo "-----------------------"
          echo "Selected TOOLCHAINS: ${{ github.event.inputs.TOOLCHAINS }}"
          echo "Selected TARGET: ${{ github.event.inputs.TARGET }}"
          echo "-----------------------"

  # Build binaries
  build-common:
    name: Build common
    needs: [build-check]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          # Platform builds
          - os: ${{ contains(github.event.inputs.TARGET, 'windows') && 'windows' || (contains(github.event.inputs.TARGET, 'apple') && 'macos' || 'ubuntu') }}-${{ contains(github.event.inputs.TARGET, 'linux') && '24.04' || contains(github.event.inputs.TARGET, 'apple') && 'latest' || contains(github.event.inputs.TARGET, 'aarch64') && '11' || 'latest' }}${{ contains(github.event.inputs.TARGET, 'aarch64') && !contains(github.event.inputs.TARGET, 'apple') && '-arm' || '' }}
            target: ${{ github.event.inputs.TARGET }}
    steps:
      - name: "ðŸ’¾ Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: "ðŸš€ Setup Rust environment"
        uses: ./.github/actions/setup
        with:
          rust-version: ${{ github.event.inputs.TOOLCHAINS }}
          target: ${{ matrix.target }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "âš™ï¸ Configure Git"
        shell: bash
        run: |
          git config --global user.name "reigadegr_action"
          git config --global user.email "1145141919810@qq.com"

      - name: "ðŸ”§ Setup TimeZone"
        if: runner.os == 'Linux'
        run: |
          sudo -E rm -rf /etc/localtime
          sudo -E ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: Optimize Memory Management
        run: |
          wget https://github.com/reigadegr/sun_action/raw/main/script/memopt.sh
          nohup sh memopt.sh >/dev/null 2>&1 &

      - name: Install Zig
        if: runner.os == 'Linux'
        uses: mlugg/setup-zig@v2
      
      - name: Install cargo-zigbuild
        if: runner.os == 'Linux'
        shell: bash
        run: |
          git clone --depth 1 https://github.com/rust-cross/cargo-zigbuild
          cd cargo-zigbuild
          cargo add mimalloc --features no_thp,override,v3
          wget https://github.com/reigadegr/rust_cli_action/raw/main/patchs/zigbuild_mimalloc.patch
          patch -p2 -F 3 < zigbuild_mimalloc.patch
          cargo update
          cargo build -r
          dd if=target/release/cargo-zigbuild of=./cargo-zigbuild
          rm -rf target
          sudo -E cp -af ./cargo-zigbuild ~/.cargo/bin/cargo-zigbuild
          sudo -E chmod +x ~/.cargo/bin/cargo-zigbuild
          ls ~/.cargo/bin
          which cargo-zigbuild || true
          cd  ..; rm -rf cargo-zigbuild

      - name: "ðŸ“¥ Download github project code"
        shell: bash
        run: |
          export MY_PAT="${{ secrets.MY_PAT }}"
          git clone --depth 1 https://reigadegr:${MY_PAT}@github.com/myProtectP/pmi-star-talent-portal common

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install frontend dependencies
        env:
          FORCE_COLOR: 1
          PNPM_COLOR: always
        run: |
          cd common
          npm install -g pnpm
          pnpm i
          pnpm build:prod

      - name: "âš™ï¸ Reset flags"
        shell: bash
        run: |
          cd common/pmi_rust_backend
          rm -rf .cargo/ || echo "æ— éœ€åˆ é™¤ç›®å½•"
          mkdir -p .cargo/
          curl -L https://github.com/reigadegr/pmi_action/raw/main/.cargo/config.toml -o .cargo/config.toml
        
      - name: "ðŸ”¨ Build common"
        shell: bash
        run: |
          cd common/pmi_rust_backend
          toolchain="${{ github.event.inputs.TOOLCHAINS }}"
          platform="${{ contains(github.event.inputs.TARGET, 'windows') && 'windows' || (contains(github.event.inputs.TARGET, 'apple') && 'apple' || 'linux') }}"
          file="build_"$toolchain"_"$platform".sh"

          url="https://github.com/reigadegr/pmi_action/raw/main/script/$file"
          echo "è„šæœ¬ç›´é“¾: $url"
          curl -L $url -o "$file"
          cat "$file"; ls -al
          
          for i in "app" "backend"; do
              bin_name="$i"
              sh "$file" "${{ matrix.target }}" "$bin_name" || true
    
              is_windows="${{ contains(github.event.inputs.TARGET, 'windows') && 'true' || 'false' }}"
              if [ "$is_windows" = "true" ]; then
                  bin_name=$bin_name.exe
              fi
              file="$(find . -name "$bin_name")"
              echo "$(realpath $file)"
              mkdir -p ../${{ github.event.inputs.TARGET }}_module || echo "å·²æœ‰é»˜è®¤ç›®å½•"
              dd if=./target/"${{ matrix.target }}"/release/$bin_name of=../../"${{ matrix.target }}"_module/$bin_name
          done
          git log > ../"${{ matrix.target }}"_module/commits.txt

      - name: "ðŸ“¤ Upload to GitHub artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.TARGET }}_pmi_user_front_web
          path: ${{ matrix.target }}_module/*
          retention-days: 3
