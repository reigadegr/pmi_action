name: update rust dep

on:
  workflow_dispatch:
    inputs:
      TOOLCHAINS:
        type: choice
        description: "ä½¿ç”¨çš„å·¥å…·é“¾"
        required: true
        default: "stable"
        options:
          - "nightly"
          - "stable"
      TARGET:
        type: choice
        description: "ç¼–è¯‘çš„ç›®æ ‡ä¸‰å…ƒç»„"
        required: true
        default: "x86_64-unknown-linux-gnu"
        options:
          - "x86_64-unknown-linux-gnu"
          - "aarch64-unknown-linux-gnu"
          - "x86_64-unknown-linux-musl"
          - "aarch64-unknown-linux-musl"
          - "x86_64-pc-windows-msvc"
          - "aarch64-pc-windows-msvc"
          - "aarch64-apple-darwin"
          - "x86_64-apple-darwin"

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Optimize build performance
  CARGO_INCREMENTAL: 0
  TZ: Asia/Shanghai

jobs:
  # Build strategy check - determine build type based on trigger
  build-check:
    name: Build Strategy Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Debug Show Selected Inputs
        run: |
          echo "-----------------------"
          echo "Selected TOOLCHAINS: ${{ github.event.inputs.TOOLCHAINS }}"
          echo "Selected TARGET: ${{ github.event.inputs.TARGET }}"
          echo "-----------------------"

  # Build binaries
  build-common:
    name: Build common
    needs: [build-check]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          # Platform builds
          - os: ${{ contains(github.event.inputs.TARGET, 'windows') && 'windows' || (contains(github.event.inputs.TARGET, 'apple') && 'macos' || 'ubuntu') }}-${{ contains(github.event.inputs.TARGET, 'linux') && '24.04' || contains(github.event.inputs.TARGET, 'apple') && 'latest' || contains(github.event.inputs.TARGET, 'aarch64') && '11' || 'latest' }}${{ contains(github.event.inputs.TARGET, 'aarch64') && !contains(github.event.inputs.TARGET, 'apple') && '-arm' || '' }}
            target: ${{ github.event.inputs.TARGET }}
    steps:
      - name: "ðŸ’¾ Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: "âš™ï¸ show Cargo config"
        if: runner.os == 'Linux'
        shell: bash
        run: |
          [ -f ~/.cargo/config.toml ] && cat ~/.cargo/config.toml || echo "cfg not found"

      - name: "ðŸš€ Setup Rust environment"
        uses: ./.github/actions/setup
        with:
          rust-version: ${{ github.event.inputs.TOOLCHAINS }}
          target: ${{ matrix.target }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "âš™ï¸ Configure Git"
        shell: bash
        run: |
          git config --global user.name "reigadegr_action"
          git config --global user.email "1145141919810@qq.com"

      - name: "ðŸ”§ Setup TimeZone"
        if: runner.os == 'Linux'
        run: |
          sudo -E rm -rf /etc/localtime
          sudo -E ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: Optimize Memory Management
        if: runner.os == 'Linux'
        run: |
          wget https://github.com/reigadegr/sun_action/raw/main/script/memopt.sh
          nohup sh memopt.sh >/dev/null 2>&1 &

      - name: "ðŸ“¥ Download github project code"
        shell: bash
        run: |
          export MY_PAT="${{ secrets.MY_PAT }}"
          git clone --depth 1 https://reigadegr:${MY_PAT}@github.com/myProtectP/pmi-star-talent-portal common

      - name: "âš™ï¸ Remove configs"
        shell: bash
        run: |
          cd common/pmi_rust_backend
          rm -rf .cargo/ || echo "æ— éœ€åˆ é™¤ç›®å½•"
        
      - name: "ðŸ”¨ Build common"
        shell: bash
        run: |
          cd common/pmi_rust_backend
          
          cargo install cargo-edit
          cargo upgrade -i
          mkdir -p ../../${{ github.event.inputs.TARGET }}_module || echo "å·²æœ‰é»˜è®¤ç›®å½•"
          git diff > ../../"${{ matrix.target }}"_module/commits.txt

      - name: "ðŸ“¤ Upload to GitHub artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.TARGET }}_pmi_rust_upgrade_dep_diff
          path: ${{ matrix.target }}_module/*
          retention-days: 3
